<div *ngIf="isLoadingCurrio" class="spinner-wrapper">
  <div class="spinner">Caricamento impostazioni Curriò...</div>
</div>

<div *ngIf="!isLoadingCurrio && !currentCurrio" class="alert alert-warning">
  Impossibile caricare i dati del tuo Curriò. Contatta l'assistenza.
</div>

<div *ngIf="!isLoadingCurrio && currentCurrio">
  <div class="row">
    <div class="col-md-12">
      <h3>{{ 'customer.currio.title' | translate }}</h3>
      <p class="text-muted">Modifica le informazioni che appaiono sul tuo Curriò pubblico.</p>
      <hr />
    </div>
  </div>

  <div *ngIf="showUnsavedChangesWarning" class="alert alert-warning d-flex align-items-center mb-3" role="alert">
    <i class="feather icon-alert-triangle me-2"></i>
    <div>
      {{ 'profiloUtente.avvisoModificheNonSalvate' | translate }}
    </div>
  </div>

  <form [formGroup]="currioForm" (ngSubmit)="onSubmit()" id="currioSettingsForm">
    <div class="row">
      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-header">{{ 'Informazioni Principali' | translate }}</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="nomePortfolio" class="form-label">{{ 'customer.currio.form.nomePortfolio' | translate }}</label>
              <input type="text" id="nomePortfolio" class="form-control" formControlName="nomePortfolio" />
              <div *ngIf="currioForm.get('nomePortfolio')?.invalid && currioForm.get('nomePortfolio')?.touched" class="text-danger small">
                {{ 'generale.errori.camporichiesto' | translate }}
              </div>
            </div>
            <div class="mb-3">
              <label for="heroTitle" class="form-label">{{ 'customer.currio.form.heroTitle' | translate }}</label>
              <input type="text" id="heroTitle" class="form-control" formControlName="heroTitle" />
              <div *ngIf="currioForm.get('heroTitle')?.invalid && currioForm.get('heroTitle')?.touched" class="text-danger small">
                {{ 'generale.errori.camporichiesto' | translate }}
              </div>
            </div>
            <div class="mb-3">
              <label for="heroSubtitle" class="form-label">{{ 'customer.currio.form.heroSubtitle' | translate }}</label>
              <textarea id="heroSubtitle" class="form-control" formControlName="heroSubtitle" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label for="linguaDefault" class="form-label">{{ 'customer.currio.form.linguaDefault' | translate }}</label>
              <select id="linguaDefault" class="form-select" formControlName="linguaDefault">
                <option value="it">Italiano</option>
                <option value="en">Inglese</option>
                </select>
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header">{{ 'Chi Sono' | translate }}</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="chiSonoFotoUrl" class="form-label">{{ 'customer.currio.form.chiSonoFotoUrl' | translate }}</label>
              <input type="url" id="chiSonoFotoUrl" class="form-control" formControlName="chiSonoFotoUrl" placeholder="https://example.com/foto.jpg" />
            </div>
            <div class="mb-3">
              <label for="chiSonoDescrizione1" class="form-label">{{ 'customer.currio.form.chiSonoDescrizione1' | translate }}</label>
              <textarea id="chiSonoDescrizione1" class="form-control" formControlName="chiSonoDescrizione1" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label for="chiSonoDescrizione2" class="form-label">{{ 'customer.currio.form.chiSonoDescrizione2' | translate }}</label>
              <textarea id="chiSonoDescrizione2" class="form-control" formControlName="chiSonoDescrizione2" rows="2"></textarea>
            </div>
          </div>
        </div>

        <div formGroupName="contatti" class="card mb-3">
          <div class="card-header">{{ 'Contatti Pubblici del Curriò' | translate }}</div>
          <div class="card-body">
            <div class="mb-3">
              <label for="contattiEmail" class="form-label">{{ 'customer.currio.form.contattiEmail' | translate }}</label>
              <input type="email" id="contattiEmail" class="form-control" formControlName="email" />
              <div *ngIf="currioForm.get('contatti.email')?.invalid && currioForm.get('contatti.email')?.touched" class="text-danger small">
                {{ 'generale.errori.mailvalida' | translate }}
              </div>
            </div>
            <div class="mb-3">
              <label for="contattiGithub" class="form-label">{{ 'customer.currio.form.contattiGithub' | translate }}</label>
              <input type="url" id="contattiGithub" class="form-control" formControlName="github" placeholder="https://github.com/tuoutente" />
            </div>
            <div class="mb-3">
              <label for="contattiLinkedin" class="form-label">{{ 'customer.currio.form.contattiLinkedin' | translate }}</label>
              <input type="url" id="contattiLinkedin" class="form-control" formControlName="linkedin" placeholder="https://linkedin.com/in/tuoutente" />
            </div>
            <div class="mb-3">
              <label for="contattiInstagram" class="form-label">{{ 'customer.currio.form.contattiInstagram' | translate }}</label>
              <input type="url" id="contattiInstagram" class="form-control" formControlName="instagram" placeholder="https://instagram.com/tuoutente" />
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>{{ 'customer.currio.progettiTitle' | translate }}</span>
            <button type="button" class="btn btn-sm btn-outline-primary" (click)="addProgetto()">
              <i class="feather icon-plus"></i> {{ 'customer.currio.addProgetto' | translate }}
            </button>
          </div>
          <div class="card-body" formArrayName="progetti">
            <div *ngFor="let progettoCtrl of progettiFormArray.controls; let i = index" [formGroupName]="i" class="mb-3 p-3 border rounded">
              <h6 class="d-flex justify-content-between align-items-center">
                {{ 'Progetto' | translate }} {{i + 1}}
                <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeProgetto(i)">
                  <i class="feather icon-trash-2"></i> {{ 'customer.currio.remove' | translate }}
                </button>
              </h6>
              <div class="mb-2">
                <label class="form-label">{{ 'customer.currio.form.progetto.titolo' | translate }}</label>
                <input type="text" class="form-control form-control-sm" formControlName="titolo">
              </div>
              <div class="mb-2">
                <label class="form-label">{{ 'customer.currio.form.progetto.descrizione' | translate }}</label>
                <textarea class="form-control form-control-sm" formControlName="descrizione" rows="2"></textarea>
              </div>
              <div class="mb-2">
                <label class="form-label">{{ 'customer.currio.form.progetto.immagineUrl' | translate }}</label>
                <input type="url" class="form-control form-control-sm" formControlName="immagineUrl">
              </div>
              <div class="mb-2">
                <label class="form-label">{{ 'customer.currio.form.progetto.linkProgetto' | translate }}</label>
                <input type="url" class="form-control form-control-sm" formControlName="linkProgetto">
              </div>
              <div formArrayName="tags">
                <label class="form-label">{{ 'customer.currio.form.progetto.tags' | translate }}</label>
                <div *ngFor="let tagCtrl of getTags(i).controls; let tagIndex = index" class="input-group input-group-sm mb-1">
                    <input type="text" class="form-control" [formControlName]="tagIndex">
                    <button class="btn btn-outline-danger btn-sm" type="button" (click)="removeTag(i, tagIndex)"><i class="feather icon-x"></i></button>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm mt-1" (click)="addTag(i)">Aggiungi Tag</button>
              </div>
            </div>
            <div *ngIf="progettiFormArray.length === 0" class="text-muted text-center py-3">
              Nessun progetto aggiunto.
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>{{ 'customer.currio.esperienzeTitle' | translate }}</span>
            <button type="button" class="btn btn-sm btn-outline-primary" (click)="addEsperienza()">
               <i class="feather icon-plus"></i> {{ 'customer.currio.addEsperienza' | translate }}
            </button>
          </div>
          <div class="card-body" formArrayName="esperienze">
             <div *ngFor="let esperienzaCtrl of esperienzeFormArray.controls; let i = index" [formGroupName]="i" class="mb-3 p-3 border rounded">
                <h6 class="d-flex justify-content-between align-items-center">
                    Esperienza/Formazione {{i + 1}}
                    <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeEsperienza(i)">
                        <i class="feather icon-trash-2"></i> {{ 'customer.currio.remove' | translate }}
                    </button>
                </h6>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">{{ 'customer.currio.form.esperienza.titolo' | translate }}</label>
                        <input type="text" class="form-control form-control-sm" formControlName="titolo">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">{{ 'customer.currio.form.esperienza.tipo' | translate }}</label>
                        <select class="form-select form-select-sm" formControlName="tipo">
                            <option value="lavoro">Lavoro</option>
                            <option value="formazione">Formazione</option>
                        </select>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label">{{ 'customer.currio.form.esperienza.aziendaScuola' | translate }}</label>
                    <input type="text" class="form-control form-control-sm" formControlName="aziendaScuola">
                </div>
                <div class="mb-2">
                    <label class="form-label">{{ 'customer.currio.form.esperienza.date' | translate }}</label>
                    <input type="text" class="form-control form-control-sm" formControlName="date">
                </div>
                <div class="mb-2">
                    <label class="form-label">{{ 'customer.currio.form.esperienza.descrizioneBreve' | translate }}</label>
                    <textarea class="form-control form-control-sm" formControlName="descrizioneBreve" rows="2"></textarea>
                </div>

                <div formArrayName="dettagli">
                    <label class="form-label">{{ 'customer.currio.form.esperienza.dettagli' | translate }}</label>
                    <div *ngFor="let dettaglioCtrl of getDettagli(i).controls; let detIndex = index" class="input-group input-group-sm mb-1">
                        <input type="text" class="form-control" [formControlName]="detIndex">
                        <button class="btn btn-outline-danger btn-sm" type="button" (click)="removeDettaglio(i, detIndex)"><i class="feather icon-x"></i></button>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm mt-1" (click)="addDettaglio(i)">Aggiungi Dettaglio</button>
                </div>

                <div formArrayName="competenzeAcquisite" class="mt-2">
                    <label class="form-label">{{ 'customer.currio.form.esperienza.competenzeAcquisite' | translate }}</label>
                    <div *ngFor="let compCtrl of getCompetenzeAcquisite(i).controls; let compIndex = index" class="input-group input-group-sm mb-1">
                        <input type="text" class="form-control" [formControlName]="compIndex">
                        <button class="btn btn-outline-danger btn-sm" type="button" (click)="removeCompetenzaAcquisita(i, compIndex)"><i class="feather icon-x"></i></button>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm mt-1" (click)="addCompetenzaAcquisita(i)">Aggiungi Competenza</button>
                </div>
            </div>
            <div *ngIf="esperienzeFormArray.length === 0" class="text-muted text-center py-3">
                Nessuna esperienza aggiunta.
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>{{ 'customer.currio.competenzeTitle' | translate }}</span>
            <button type="button" class="btn btn-sm btn-outline-primary" (click)="addCompetenza()">
              <i class="feather icon-plus"></i> {{ 'customer.currio.addCompetenza' | translate }}
            </button>
          </div>
          <div class="card-body" formArrayName="competenze">
            <div *ngFor="let competenzaCtrl of competenzeFormArray.controls; let i = index" [formGroupName]="i" class="mb-3 p-3 border rounded">
                <h6 class="d-flex justify-content-between align-items-center">
                    Competenza {{i + 1}}
                    <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeCompetenza(i)">
                        <i class="feather icon-trash-2"></i> {{ 'customer.currio.remove' | translate }}
                    </button>
                </h6>
                <div class="mb-2">
                    <label class="form-label">{{ 'customer.currio.form.competenza.nome' | translate }}</label>
                    <input type="text" class="form-control form-control-sm" formControlName="nome">
                </div>
                 <div class="mb-2">
                    <label class="form-label">{{ 'customer.currio.form.competenza.livello' | translate }}</label>
                    <input type="text" class="form-control form-control-sm" formControlName="livello">
                </div>
                 <div class="mb-2">
                    <label class="form-label">{{ 'customer.currio.form.competenza.icona' | translate }}</label>
                    <textarea class="form-control form-control-sm" formControlName="icona" rows="2" placeholder='<svg>...</svg>'></textarea>
                    <small class="form-text text-muted">Incolla qui il codice SVG completo per l'icona (opzionale).</small>
                </div>
            </div>
            <div *ngIf="competenzeFormArray.length === 0" class="text-muted text-center py-3">
                Nessuna competenza aggiunta.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-12 text-center">
        <button type="submit" form="currioSettingsForm" class="btn btn-lg btn-success" [disabled]="!currioForm.valid || !currioForm.dirty || (isSubmitting$ | async)">
          <i class="feather icon-save"></i>
          <span *ngIf="!(isSubmitting$ | async)"> {{ 'generale.shared.salva' | translate }}</span>
          <span *ngIf="isSubmitting$ | async" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <span *ngIf="isSubmitting$ | async"> Salvataggio...</span>
        </button>
      </div>
    </div>
  </form>
</div>
